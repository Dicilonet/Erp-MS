rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // REGLAS GENERALES
    match /{document=**} {
      // Por defecto, nadie tiene acceso a nada.
      allow read, write: if false;
    }

    // --- REGLAS PARA USUARIOS (CORREGIDO PARA MODELO MULTI-EMPRESA) ---
    match /users/{userId} {
      // Un usuario puede LEER (get) y ACTUALIZAR (update) su propio perfil.
      allow get, update: if request.auth.uid == userId;

      // Un usuario puede LISTAR otros usuarios SÓLO SI está pidiendo los de su propia empresa.
      // Esta regla comprueba que la consulta del frontend filtre por el companyId del usuario que hace la petición.
      allow list: if request.auth != null &&
                    request.query.filters[0].field == "companyId" &&
                    request.query.filters[0].value == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;

      // Los superadmins pueden gestionar CUALQUIER usuario.
      allow get, list, create, update, delete: if request.auth.token.role == 'superadmin';
      
      // Reglas para la subcolección de tareas personales.
      match /todos/{todoId} {
        allow read, write: if request.auth.uid == userId;
      }
    }
    
    // --- REGLAS PARA CONTADORES (USADO EN CUPONES Y OFERTAS) ---
    match /counters/{counterId} {
      // Solo los usuarios autenticados (admins) pueden leer/escribir contadores.
      allow read, write: if request.auth != null && request.auth.token.role == 'superadmin';
    }

    // --- REGLAS PARA CLIENTES (Customers) ---
    match /customers/{customerId} {
      // Cualquier usuario autenticado del ERP puede leer la lista de clientes.
      allow read: if request.auth != null;
      // Solo superadmins pueden crear, modificar o borrar clientes.
      allow write: if request.auth.token.role == 'superadmin';

      // Subcolecciones de clientes (interacciones, ofertas, etc.)
      match /{allPaths=**} {
        allow read, write: if request.auth != null;
      }
    }
    
    // --- REGLAS PARA ARTÍCULOS ---
    match /articles/{articleId} {
        // Cualquiera autenticado puede leer, solo admins escriben
        allow read: if request.auth != null;
        allow write: if request.auth.token.role == 'superadmin';
    }

    // --- REGLAS PARA GASTOS (Expenses) ---
    match /expenses/{expenseId} {
        // Cualquiera autenticado puede leer, solo admins escriben
        allow read: if request.auth != null;
        allow write: if request.auth.token.role == 'superadmin';
    }
    
    // --- REGLAS PARA PROYECTOS ---
    match /projects/{projectId} {
      // Un usuario puede leer un proyecto si es superadmin o si su UID está en el array 'assignedTeam'.
      allow read: if request.auth.token.role == 'superadmin' || request.auth.uid in resource.data.assignedTeam;
      // Un usuario puede escribir en un proyecto si es superadmin o si está en el equipo.
      allow write: if request.auth.token.role == 'superadmin' || request.auth.uid in resource.data.assignedTeam;
      
        // REGLAS PARA TAREAS DENTRO DE UN PROYECTO
        match /tasks/{taskId} {
          // Hereda los permisos del proyecto padre.
          allow read, write: if request.auth.token.role == 'superadmin' || request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.assignedTeam;
        }
    }
    
    // REGLA PARA COLLECTION GROUP 'tasks'
    // Permite a un superadmin hacer una consulta sobre todas las tareas de todos los proyectos.
    match /{path=**}/tasks/{taskId} {
        allow read: if request.auth.token.role == 'superadmin';
    }


    // --- REGLAS PARA MARKETING (Content & Schedule) ---
    match /contentAssets/{assetId} {
      // Cualquiera autenticado puede leer, solo admins escriben.
      allow read: if request.auth != null;
      allow write: if request.auth.token.role == 'superadmin';
    }
    match /marketingSchedule/{eventId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.role == 'superadmin';
    }

    // --- REGLAS PARA CHAT ---
    match /conversations/{conversationId} {
        // Un usuario puede leer/escribir una conversación si su UID está en la lista de participantes.
        allow read, write: if request.auth.uid in resource.data.participantUids;
        
        match /messages/{messageId} {
            allow read, write: if request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantUids;
        }
    }
    
    // --- REGLAS PARA TICKETS DE SOPORTE ---
    match /tickets/{ticketId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.role == 'superadmin';
    }
    
    // --- REGLAS PARA CATÁLOGO DE CONEXIONES/PROGRAMAS ---
    match /programs/{programId} {
        allow read: if request.auth != null;
        allow write: if request.auth.token.role == 'superadmin';
    }

    // --- REGLAS PARA EL MÓDULO DE CUPONES ---
    match /coupons/{couponId} {
      // CORRECCIÓN: Se permite la lectura pública para que la página de canje funcione,
      // pero la escritura se mantiene restringida a los administradores.
      allow read: if true;
      allow write: if request.auth.token.role == 'superadmin';
    }
  }
}