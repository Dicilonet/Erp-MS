rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Funciones de Ayuda ---
    function isSuperadmin() {
      return request.auth.token.role == 'superadmin';
    }

    function isColaborador() {
      return request.auth.token.role == 'colaborador';
    }
    
    function isEditor() {
        return isSuperadmin() || isColaborador();
    }

    // --- Reglas de Usuario ---
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isSuperadmin();
      
      match /todos/{todoId} {
        allow read, write: if request.auth.uid == userId || isSuperadmin();
      }
      match /connections/{connectionId} {
          allow read, write: if request.auth.uid == userId || isSuperadmin();
      }
    }
    
    // --- Reglas de Cliente (CORREGIDAS) ---
    match /customers/{customerId} {
      // Cualquiera autenticado puede leer datos de un cliente.
      allow read: if request.auth != null;
      // Solo editores (superadmin/colaborador) pueden crear, actualizar o borrar clientes.
      allow create, update, delete: if isEditor();

      // Reglas para subcolecciones de clientes
      match /customerServices/{serviceId} {
        allow read, write: if isEditor();
      }
      match /interactions/{interactionId} {
        allow read, write: if isEditor();
      }
      match /offers/{offerId} {
        allow read, write: if isEditor();
      }
       match /metrics/{metricId} {
        allow read, write: if isEditor();
      }
       match /landingPageContent/{contentId} {
        allow read, write: if isEditor();
      }
    }
    
    // --- Reglas de Proyectos y Tareas ---
    match /projects/{projectId} {
      allow read, write: if request.auth.uid in resource.data.assignedTeam || isSuperadmin();
      
      match /tasks/{taskId} {
         allow read, write: if get(/databases/$(database)/documents/projects/$(projectId)).data.assignedTeam.hasAny([request.auth.uid]) || isSuperadmin();
      }
    }
    
    // --- Reglas de Art√≠culos ---
    match /articles/{articleId} {
        allow read: if request.auth != null;
        allow write: if isEditor();
    }
    
    // --- Reglas de Contadores ---
    match /counters/{counterId} {
      allow read, write: if isEditor();
    }

    // --- Reglas de Cupones ---
    match /coupons/{couponId} {
      // Cualquiera puede leer para canjear, pero solo los editores pueden modificar.
      allow read: if true;
      allow create, update, delete: if isEditor();
    }
    
     // --- Reglas de Contenido y Marketing ---
    match /contentAssets/{assetId} {
      allow read, write: if isEditor();
    }

    match /marketingSchedule/{eventId} {
      allow read, write: if isEditor();
    }

     // --- Reglas de Soporte ---
    match /tickets/{ticketId} {
        allow read, write: if isEditor();
    }

    // --- Reglas de Chat ---
    match /conversations/{conversationId} {
        allow read, write: if request.auth.uid in resource.data.participantUids;
        
        match /messages/{messageId} {
            allow read, write: if request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantUids;
        }
    }
  }
}
